<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tiempo360</title>
<link rel="icon" type="image/png" href="favicon.png">
<style>
body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; margin: 0; transition: background-color 0.3s, color 0.3s, background-image 0.5s ease-in-out; }
body.modo-claro { background-image: url('./LIGHT.webp'); background-size: cover; background-position: center; background-repeat: no-repeat; color: #1a1a1a; }
body.modo-oscuro { background-image: url('./DARK.webp'); background-size: cover; background-position: center; background-repeat: no-repeat; color: #e0e0e0; }
.texto-azul { color: inherit; }
body.modo-claro .texto-azul { color: #0D47A1 !important; }
body.modo-oscuro .texto-azul { color: #90D5FF !important; }

h1, h3 { font-size: 1.2em; margin: 10px 0; }
.reloj { font-size: 1.8em; font-weight: bold; margin: 10px 0; }
.zona, #semanaActual { font-size: 1em; font-weight: normal; margin: 10px 0; color: inherit; }

.seccion { margin: 20px auto; padding: 15px; border-radius: 8px; max-width: 600px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); background-color: rgba(255,255,255,0.9);}
body.modo-oscuro .seccion { background-color: rgba(50,50,50,0.9); }

input, button { padding: 10px; margin: 5px; font-size: 1em; border-radius: 5px; border: 1px solid #ccc; width: 90%; max-width: 300px; box-sizing: border-box;}
button { background-color: #3498db; color: white; border: none; cursor: pointer; transition: background-color 0.2s; }
button:hover { background-color: #2980b9; }

#modo-toggle { position: fixed; right: clamp(10px, 2vw, 24px); bottom: clamp(10px, 2vw, 24px); font-size: clamp(1.25rem, 0.9rem + 1vw, 1.75rem); background: none; border: none; cursor: pointer; }
#modo-toggle:focus { outline: 2px solid #3498db; }

/* --- Ajuste modo-toggle color según modo --- */
body.modo-claro #modo-toggle {
  color: #111;
}
body.modo-oscuro #modo-toggle {
  color: #fff;
}

.calendar-container {
  max-width: 600px;
  margin: 20px auto;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  background-color: rgba(255,255,255,0.9);
}
body.modo-oscuro .calendar-container { background-color: rgba(50,50,50,0.9);}
.calendar-container iframe {
  width: 100%;
  min-width: 250px;
  height: 350px;
  max-width: 600px;
  border: none;
  display: block;
  margin: 0 auto;
}

.firma { margin-top: 15px; font-size: 0.8em; text-align: center; opacity: 0.7; }
body.modo-claro .firma { color: #666; }
body.modo-oscuro .firma { color: #aaa; }

.error { color: orange; font-weight: bold; font-style: italic; font-size: 0.9em; margin-top: 5px; opacity: 0; transition: opacity 0.4s; display: flex; align-items: center; justify-content: center; }
.error.visible { opacity: 1; }
.icono { margin-right: 5px; }
.input-error { border: 2px solid orange; animation: parpadeo 0.6s ease-in-out 2; }
@keyframes parpadeo { 0%,100%{ border-color: transparent;} 50%{ border-color: orange; } }

#idiomas { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
#idiomas img { width: 40px; height: 26px; cursor: pointer; border-radius: 4px; transition: transform 0.2s; }
#idiomas img:hover, #idiomas img.active { transform: scale(1.1); border: 2px solid #3498db; }

/* --- Responsive para móviles --- */
@media(max-width:480px) { 
  .reloj { font-size: 1.5em;} 
  input, button { width: 95%; } 
  .calendar-container { max-width: 95vw; }
  .calendar-container iframe { height: 280px; min-width: 0; max-width: 100%; }
  #weather-widget { flex-direction: column; align-items: center; gap: 10px; }
  #weather-widget .weather-main { 
    flex-direction: row !important;
    align-items: center; 
    gap: 5px; 
  }
}

@media(min-width:481px) and (max-width:768px) { 
  input, button { max-width: 90%; } 
  .calendar-container { max-width: 99vw; }
  .calendar-container iframe { height: 320px; min-width: 0; max-width: 100%; }
  #weather-widget .weather-main {
    flex-direction: row !important;
    align-items: center;
    gap: 15px;
  }
}

.weather-widget-seccion {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 15px;
  margin: 20px auto;
}

.weather-main {
  display: flex;
  align-items: center;
  gap: 15px;
  flex-direction: row;
}

.weather-info {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}

.city-search {
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
  gap: 10px;
  position: relative;
  width: 100%;
  max-width: 400px;
}
.city-search input {
  flex: 1;
  min-width: 150px;
  margin-right: 0;
}

.suggestions-list {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  min-width: 100%;
  max-height: 150px;
  overflow-y: auto;
  background: #fff !important;
  color: #111 !important;
  border: 1px solid #ccc;
  border-radius: 4px;
  z-index: 10;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  margin-top: 2px;
  padding: 0;
  list-style: none;
}
.suggestions-list li {
  padding: 8px 12px;
  cursor: pointer;
  color: #111 !important;
  background: #fff !important;
  transition: background-color 0.2s, color 0.2s;
}
.suggestions-list li.active,
.suggestions-list li:hover {
  background-color: #3498db !important;
  color: #fff !important;
}

#weather-temp {
  font-size: 1.8em;
  font-weight: bold;
  color: inherit;
  margin-right: 10px;
  display: inline-block;
  width: 60px;
  text-align: right;
}
#weather-emoji {
  display: inline-block;
  width: 30px;
  height: 30px;
  line-height: 30px;
  font-size: 30px;
  text-align: center;
}
#city-name {
  font-weight: bold;
}
</style>
</head>
<body aria-label="Calculadora de tiempo" role="main">

<h1 id="titulo" tabindex="0">
  <img id="titulo-img" src="Logoweb_Clear.png" alt="Tiempo360 - El tiempo desde todas sus dimensiones...">
</h1>

<div id="idiomas" aria-label="Selector de idioma" role="radiogroup">
  <img src="ESP.png" alt="Español" data-lang="es" onclick="cambiarIdioma('es')" title="Español" role="radio" aria-checked="false" tabindex="0">
  <img src="CAT.png" alt="Català" data-lang="ca" onclick="cambiarIdioma('ca')" title="Català" role="radio" aria-checked="false" tabindex="0">
  <img src="GAL.png" alt="Galego" data-lang="gl" onclick="cambiarIdioma('gl')" title="Galego" role="radio" aria-checked="false" tabindex="0">
  <img src="EUS.png" alt="Euskera" data-lang="eu" onclick="cambiarIdioma('eu')" title="Euskera" role="radio" aria-checked="false" tabindex="0">
</div>

<div class="reloj texto-azul" id="reloj" aria-live="polite" aria-atomic="true"></div>
<div class="zona" id="zonaHoraria" aria-live="polite"></div>
<p id="semanaActual" aria-live="polite"></p>

<div id="weather-widget" class="weather-widget-seccion" aria-label="Widget del tiempo" role="region">
  <div class="weather-main" aria-label="Información meteorológica principal" role="group">
    <span id="weather-temp" class="texto-azul" aria-label="Temperatura actual"></span>
    <span id="weather-emoji" aria-label="Icono meteorológico"></span>
    <div class="weather-info" aria-label="Información de ciudad y detalles">
      <span id="city-name" class="texto-azul" aria-label="Ciudad"></span>
      <small id="details" aria-label="Detalles del tiempo"></small>
    </div>
  </div>

  <div class="city-search" aria-label="Buscador de ciudad" role="search">
    <input type="text" id="city-input" placeholder="Introduce una ciudad..." autocomplete="off"
     aria-autocomplete="list" aria-haspopup="listbox" aria-expanded="false" aria-controls="suggestions" aria-label="Campo de búsqueda de ciudad" />
    <ul id="suggestions" class="suggestions-list" role="listbox" aria-label="Sugerencias de ciudad"></ul>
  </div>
</div>

<div class="calendar-container" aria-label="Calendario de festivos" role="region">
  <iframe src="https://calendar.google.com/calendar/embed?height=600&wkst=2&ctz=Europe%2FMadrid&showCalendars=0&showTitle=0&title=Festivos&showTz=0&showDate=0&src=ZXMuc3BhaW4jaG9saWRheUBncm91cC52LmNhbGVuZGFyLmdvb2dsZS5jb20&color=%230b8043" style="border-width:0" width="800" height="600" frameborder="0" scrolling="no"></iframe>
</div>  
  
<div class="seccion" aria-label="Cálculo de número de semana" role="region">
  <h3 class="texto-azul" id="h3Semana" tabindex="0"></h3>
  <input type="date" id="fecha" aria-label="Fecha para calcular semana">
  <button id="btnCalcularSemana" onclick="calcularSemana()" aria-label="Calcular semana"></button>
  <div class="resultado" id="resultado" aria-live="polite"></div>
  <p class="error" id="errorSemana" aria-live="assertive"><span class="icono">⚠️</span></p>
</div>

<div class="seccion" aria-label="Cálculo de días entre dos fechas" role="region">
  <h3 class="texto-azul" id="h3Dias" tabindex="0"></h3>
  <input type="date" id="fechaInicio" aria-label="Fecha de inicio">
  <span id="a-label">a</span>
  <input type="date" id="fechaFin" aria-label="Fecha de fin">
  <button id="btnCalcularDias" onclick="calcularDias()" aria-label="Calcular días"></button>
  <p class="resultado" id="resultadoDias" aria-live="polite"></p>
  <p class="error" id="errorDias" aria-live="assertive"><span class="icono">⚠️</span></p>
</div>

<div class="seccion" aria-label="Cálculo de fechas de una semana" role="region">
  <h3 class="texto-azul" id="h3Rango" tabindex="0"></h3>
  <label id="labelSemana" for="semanaInput"></label>
  <input type="number" id="semanaInput" min="1" max="53" aria-label="Número de semana">
  <button id="btnMostrarRango" onclick="calcularRangoSemana()" aria-label="Mostrar rango de semana"></button>
  <p class="resultado" id="resultadoSemana" aria-live="polite"></p>
  <p class="error" id="errorRangoSemana" aria-live="assertive"><span class="icono">⚠️</span></p>
</div>

<button id="modo-toggle" onclick="toggleModo()" aria-label="Cambiar modo claro/oscuro" title="Cambiar modo claro/oscuro">☀︎/☾</button> 

<footer class="firma" id="footerFirma" tabindex="0" aria-label="Pie de página"></footer>

<script>
// --- Traducciones coherentes ---
const traducciones = {
  es: {
    tituloAlt: "Tiempo360 - El tiempo desde todas sus dimensiones...",
    lugarLabel: "Lugar:",
    buscarBtn: "Buscar",
    titulo: "Calculadora de tiempo",
    h3Semana: "Número de semana",
    btnCalcularSemana: "Calcular",
    semanaDe: "{fecha} > Semana {semana}",
    diasEntre: "{total} días ({años} años, {meses} meses, {dias} días)",
    rangoSemana: "Semana {semana}: del {inicio} al {fin}",
    h3Dias: "Tiempo entre dos fechas",
    btnCalcularDias: "Calcular",
    h3Rango: "Fechas de una semana",
    labelSemana: "Semana del año (1-53):",
    btnMostrarRango: "Mostrar",
    placeholderInicio: "Fecha de inicio",
    placeholderFin: "Fecha de fin",
    placeholderSemana: "Número de semana",
    placeholderCiudad: "Introduce una ciudad...",
    errorFecha: "Introduce una fecha válida.",
    errorFechas: "Introduce fechas válidas en ambos campos.",
    errorFinAntesInicio: "La fecha final no puede ser anterior a la inicial.",
    errorSemana: "Introduce un número de semana válido entre 1 y 53.",
    horaActual: "Hora actual:",
    zonaHorariaTpl: "Hora local de España ({gmt})",
    semanaActual: "Hoy es {fecha} y estamos en la semana número {semana} del año.",
    footer: "El sitio podría contener errores, por favor contrasta la información. Calculadora de tiempo V5.0 por DGCSe7en - Github"
  },
  ca: {
    tituloAlt: "Tiempo360 - El temps des de totes les seves dimensions...",
    lugarLabel: "Lloc:",
    buscarBtn: "Cercar",
    titulo: "Calculadora de temps",
    h3Semana: "Número de setmana",
    btnCalcularSemana: "Calcular",
    semanaDe: "{fecha} > Setmana {semana}",
    diasEntre: "{total} dies ({años} anys, {meses} mesos, {dias} dies)",
    rangoSemana: "Setmana {semana}: del {inicio} al {fin}",
    h3Dias: "Temps entre dues dates",
    btnCalcularDias: "Calcular",
    h3Rango: "Dates d’una setmana",
    labelSemana: "Setmana de l’any (1-53):",
    btnMostrarRango: "Mostrar",
    placeholderInicio: "Data d'inici",
    placeholderFin: "Data de fi",
    placeholderSemana: "Número de setmana",
    placeholderCiudad: "Introdueix una ciutat...",
    errorFecha: "Introdueix una data vàlida.",
    errorFechas: "Introdueix dates vàlides en tots dos camps.",
    errorFinAntesInicio: "La data final no pot ser anterior a la inicial.",
    errorSemana: "Introdueix un número de setmana vàlid entre 1 i 53.",
    horaActual: "Hora actual:",
    zonaHorariaTpl: "Hora local d'Espanya ({gmt})",
    semanaActual: "Avui és {fecha} i estem a la setmana número {semana} de l’any.",
    footer: "El lloc podria contenir errors, si us plau contrasta la informació. Calculadora de temps V5.0 per DGCSe7en - Github"
  },
  gl: {
    tituloAlt: "Tiempo360 - O tempo desde todas as súas dimensións...",
    lugarLabel: "Lugar:",
    buscarBtn: "Buscar",
    titulo: "Calculadora de tempo",
    h3Semana: "Número de semana",
    btnCalcularSemana: "Calcular",
    semanaDe: "{fecha} > Semana {semana}",
    diasEntre: "{total} días ({años} anos, {meses} meses, {dias} días)",
    rangoSemana: "Semana {semana}: do {inicio} ao {fin}",
    h3Dias: "Tempo entre dúas datas",
    btnCalcularDias: "Calcular",
    h3Rango: "Datas dunha semana",
    labelSemana: "Semana do ano (1-53):",
    btnMostrarRango: "Mostrar",
    placeholderInicio: "Data de inicio",
    placeholderFin: "Data de fin",
    placeholderSemana: "Número de semana",
    placeholderCiudad: "Introduce unha cidade...",
    errorFecha: "Introduce unha data válida.",
    errorFechas: "Introduce datas válidas en ambos campos.",
    errorFinAntesInicio: "A data final non pode ser anterior á inicial.",
    errorSemana: "Introduce un número de semana válido entre 1 e 53.",
    horaActual: "Hora actual:",
    zonaHorariaTpl: "Hora local de España ({gmt})",
    semanaActual: "Hoxe é {fecha} e estamos na semana número {semana} do ano.",
    footer: "O sitio pode conter erros, por favor contrasta a información. Calculadora de tempo V5.0 por DGCSe7en - Github"
  },
  eu: {
    tituloAlt: "Tiempo360 - Denbora bere dimentsio guztietatik...",
    lugarLabel: "Lekua:",
    buscarBtn: "Bilatu",
    titulo: "Denboraren kalkulagailua",
    h3Semana: "Aste zenbakia",
    btnCalcularSemana: "Kalkulatu",
    semanaDe: "{fecha} > {semana}. astea",
    diasEntre: "{total} egun ({años} urte, {meses} hilabete, {dias} egun)",
    rangoSemana: "{semana}. astea: {inicio}tik {fin}ra",
    h3Dias: "Bi daten arteko denbora",
    btnCalcularDias: "Kalkulatu",
    h3Rango: "Aste bateko datak",
    labelSemana: "Urteko astea (1-53):",
    btnMostrarRango: "Erakutsi",
    placeholderInicio: "Hasiera data",
    placeholderFin: "Amaiera data",
    placeholderSemana: "Aste zenbakia",
    placeholderCiudad: "Hiri bat sartu...",
    errorFecha: "Sartu baliozko data bat.",
    errorFechas: "Sartu baliozko datak bi eremuetan.",
    errorFinAntesInicio: "Amaiera data ezin da hasierakoa baino lehenagokoa izan.",
    errorSemana: "Sartu 1 eta 53 arteko aste-zenbaki baliozkoa.",
    horaActual: "Ordu orain:",
    zonaHorariaTpl: "Espainiako ordu lokala ({gmt})",
    semanaActual: "Gaur {fecha} da eta urteko {semana}. astean gaude.",
    footer: "Guneak akatsak izan ditzake, mesedez kontrastatu informazioa. Denboraren kalkulagailua V5.0 DGCSe7en - Github"
  }
};

function actualizarLogo() {
  const logo = document.getElementById('titulo-img');
  if (!logo) return;

  // Detectar idioma activo
  const lang = document.querySelector('#idiomas img.active')?.dataset.lang || 'es';
  const t = traducciones[lang];

  // Cambiar imagen según modo
  logo.src = document.body.classList.contains('modo-oscuro') 
    ? 'Logoweb_Dark.png' 
    : 'Logoweb_Clear.png';

  // Actualizar alt según idioma
  logo.alt = t.tituloAlt || "Tiempo360 - El tiempo desde todas sus dimensiones...";
}

function formatoFecha(fecha){ 
  const dia=String(fecha.getDate()).padStart(2,'0'); 
  const mes=String(fecha.getMonth()+1).padStart(2,'0'); 
  const año=fecha.getFullYear(); 
  return `${dia}/${mes}/${año}`; 
}

function obtenerGMTMadrid() {
  const diff = - (new Date().getTimezoneOffset());
  return (diff === 120) ? 'GMT+2' : 'GMT+1';
}

// --- Reloj ---
function actualizarReloj(){
  const ahora=new Date();
  const lang = document.querySelector('#idiomas img.active')?.dataset.lang || 'es';
  const t = traducciones[lang];
  document.getElementById("reloj").innerText =
    `${t.horaActual} ${ahora.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false, timeZone:'Europe/Madrid'})}`;
  const gmt = obtenerGMTMadrid();
  document.getElementById("zonaHoraria").innerText =
    t.zonaHorariaTpl.replace("{gmt}", gmt);
}
setInterval(actualizarReloj,1000);

// --- Manejo de errores ---
function mostrarError(inputId,errorId,mensaje){
  const input = document.getElementById(inputId);
  const error = document.getElementById(errorId);
  if (input) input.classList.add('input-error');
  if (error) {
    error.innerHTML = `<span class="icono">⚠️</span>${mensaje}`;
    error.classList.add('visible');
  }
  setTimeout(()=>{ if (input) input.classList.remove('input-error'); },1200);
  setTimeout(()=>{ if (error) error.classList.remove('visible'); },3000);
}

// --- Toggle modo claro/oscuro ---
function toggleModo(){
  const body=document.body;
  if(body.classList.contains('modo-oscuro')){
    body.classList.remove('modo-oscuro');
    body.classList.add('modo-claro');
    localStorage.setItem('modo','claro');
  }else{
    body.classList.remove('modo-claro');
    body.classList.add('modo-oscuro');
    localStorage.setItem('modo','oscuro');
  }
}

window.onload=function(){
  const modoGuardado=localStorage.getItem('modo');
  if(modoGuardado==='oscuro'){
    document.body.classList.add('modo-oscuro');
  } else {
    document.body.classList.add('modo-claro');
  }
  cambiarIdioma('es');
  actualizarRadiosIdioma('es');
};

// --- Cambio de idioma ---
function cambiarIdioma(lang) {
  document.documentElement.lang = lang;
  document.querySelectorAll('#idiomas img').forEach(img => {
    img.classList.remove('active');
    img.setAttribute("aria-checked", "false");
  });
  const img = document.querySelector(`#idiomas img[data-lang="${lang}"]`);
  if (img) {
    img.classList.add('active');
    img.setAttribute("aria-checked", "true");
    img.focus();
  }
  actualizarRadiosIdioma(lang);
  const t = traducciones[lang];
  if (!t) return;
  // document.getElementById("save-city").textContent = t.buscarBtn; // ELIMINADO PORQUE YA NO HAY BOTÓN
  document.getElementById('titulo').textContent = t.titulo;
  document.getElementById('h3Semana').textContent = t.h3Semana;
  document.getElementById('btnCalcularSemana').textContent = t.btnCalcularSemana;
  document.getElementById('h3Dias').textContent = t.h3Dias;
  document.getElementById('btnCalcularDias').textContent = t.btnCalcularDias;
  document.getElementById('h3Rango').textContent = t.h3Rango;
  document.getElementById('labelSemana').textContent = t.labelSemana;
  document.getElementById('btnMostrarRango').textContent = t.btnMostrarRango;
  document.getElementById('footerFirma').textContent = t.footer;
  document.getElementById('fechaInicio').placeholder = t.placeholderInicio;
  document.getElementById('fechaFin').placeholder = t.placeholderFin;
  document.getElementById('semanaInput').placeholder = t.placeholderSemana;
  document.getElementById('a-label').textContent = (lang === 'ca' || lang === 'gl') ? 'a' : (lang === 'eu') ? 'eta' : 'a';
  mostrarSemanaActual(lang);
  ['resultado', 'resultadoDias', 'resultadoSemana'].forEach(id => {
    if(document.getElementById(id)) document.getElementById(id).textContent = "";
  });
  ['errorSemana', 'errorDias', 'errorRangoSemana'].forEach(id => {
    if(document.getElementById(id)) document.getElementById(id).textContent = "";
  });
  actualizarReloj();
  actualizarIdiomaCiudad(lang);
}

function actualizarRadiosIdioma(lang) {
  document.querySelectorAll('#idiomas img').forEach(img => {
    img.setAttribute("aria-checked", img.dataset.lang === lang ? "true" : "false");
  });
}

// --- Función de limpieza de todos los inputs relevantes ---
function limpiarInputs(ids) {
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
}

// --- Funciones de cálculo ---
function getSemanaISO(fecha){
  const tmp = new Date(fecha.getTime());
  tmp.setHours(0,0,0,0);
  tmp.setDate(tmp.getDate() + 3 - (tmp.getDay() + 6) % 7);
  const primerJueves = new Date(tmp.getFullYear(),0,4);
  return 1 + Math.round(((tmp - primerJueves)/ (7 * 24 * 60 * 60 * 1000)));
}

function calcularSemana(){
  const fechaInput=document.getElementById("fecha").value;
  const lang = document.querySelector('#idiomas img.active')?.dataset.lang || 'es';
  const t = traducciones[lang];
  if(!fechaInput){ 
    mostrarError("fecha","errorSemana",t.errorFecha); 
    limpiarInputs(["fecha"]);
    return; 
  }
  const fecha=new Date(fechaInput);
  if(isNaN(fecha)){ 
    mostrarError("fecha","errorSemana",t.errorFecha); 
    limpiarInputs(["fecha"]);
    return; 
  }
  const semana=getSemanaISO(fecha);
  document.getElementById("resultado").innerText = t.semanaDe
    .replace("{fecha}", formatoFecha(fecha))
    .replace("{semana}", semana);
  limpiarInputs(["fecha"]);
}

function mostrarSemanaActual(lang){
  const hoy=new Date();
  const semanaActual=getSemanaISO(hoy);
  const t = traducciones[lang];
  document.getElementById("semanaActual").innerText = t.semanaActual
    .replace("{fecha}",formatoFecha(hoy))
    .replace("{semana}",semanaActual);
}

function calcularDias(){
  const inicioVal=document.getElementById("fechaInicio").value;
  const finVal=document.getElementById("fechaFin").value;
  const lang = document.querySelector('#idiomas img.active')?.dataset.lang || 'es';
  const t = traducciones[lang];
  if(!inicioVal || !finVal){
    mostrarError("fechaInicio","errorDias", t.errorFechas);
    limpiarInputs(["fechaInicio","fechaFin"]);
    return;
  }
  const fechaInicio=new Date(inicioVal);
  const fechaFin=new Date(finVal);
  if(isNaN(fechaInicio) || isNaN(fechaFin)){
    mostrarError("fechaInicio","errorDias", t.errorFechas);
    limpiarInputs(["fechaInicio","fechaFin"]);
    return;
  }
  if(fechaFin < fechaInicio){
    mostrarError("fechaFin","errorDias", t.errorFinAntesInicio);
    limpiarInputs(["fechaFin"]);
    return;
  }
  let años=fechaFin.getFullYear()-fechaInicio.getFullYear();
  let meses=fechaFin.getMonth()-fechaInicio.getMonth();
  let dias=fechaFin.getDate()-fechaInicio.getDate();
  if(dias<0){ 
    meses--; 
    dias+=new Date(fechaFin.getFullYear(),fechaFin.getMonth(),0).getDate(); 
  }
  if(meses<0){ 
    años--; 
    meses+=12; 
  }
  const diasTotales=Math.round((fechaFin-fechaInicio)/(1000*60*60*24));
  document.getElementById("resultadoDias").textContent=t.diasEntre
    .replace("{total}", diasTotales)
    .replace("{años}", años)
    .replace("{meses}", meses)
    .replace("{dias}", dias);
  limpiarInputs(["fechaInicio","fechaFin"]);
}

function calcularRangoSemana(){
  const semanaInput = document.getElementById("semanaInput").value;
  const semana = parseInt(semanaInput, 10);
  const lang = document.querySelector('#idiomas img.active')?.dataset.lang || 'es';
  const t = traducciones[lang];
  if(isNaN(semana) || semana < 1 || semana > 53){
    mostrarError("semanaInput","errorRangoSemana", t.errorSemana);
    limpiarInputs(["semanaInput"]);
    return;
  }
  const año = new Date().getFullYear();
  const primerJueves = new Date(año,0,4);
  const diaSemana = (primerJueves.getDay() + 6) % 7;
  const inicioSemana = new Date(primerJueves);
  inicioSemana.setDate(primerJueves.getDate() - diaSemana + (semana - 1) * 7);
  const finSemana = new Date(inicioSemana);
  finSemana.setDate(inicioSemana.getDate() + 6);
  document.getElementById("resultadoSemana").textContent=t.rangoSemana
    .replace("{semana}", semana)
    .replace("{inicio}", formatoFecha(inicioSemana))
    .replace("{fin}", formatoFecha(finSemana));
  limpiarInputs(["semanaInput"]);
}

// --- CONFIG CLIMA ---
const apiKey = "6190233d77058dc3f79f839252cc0058";
// const saveBtn = document.getElementById("save-city"); // ELIMINADO
const inputCity = document.getElementById("city-input");
const cityName = document.getElementById("city-name");
const details = document.getElementById("details");

// --- FUNCIONES ---
function getEmoji(weatherMain) {
  const mapping = {
    Thunderstorm: "⛈️",
    Drizzle: "🌦️",
    Rain: "🌧️",
    Snow: "❄️",
    Clear: "☀️",
    Clouds: "☁️",
    Mist: "🌫️",
    Smoke: "💨",
    Haze: "🌤️",
    Dust: "🌪️",
    Fog: "🌫️",
    Sand: "🏜️",
    Ash: "🌋",
    Squall: "💨",
    Tornado: "🌪️"
  };
  return mapping[weatherMain] || "🌍";
}
async function obtenerClima(ciudad) {
  try {
    const idioma = localStorage.getItem("idiomaSeleccionado") || "es";
    const resultados = await buscarCiudad(ciudad);
    if (!resultados[0]) {
      cityName.textContent = traducir("Ciudad no encontrada", idioma);
      details.textContent = "";
      document.getElementById("weather-temp").textContent = "";
      document.getElementById("weather-emoji").textContent = "";
      return;
    }
    const { lat, lon } = resultados[0];
    obtenerClimaPorCoordenadas(lat, lon);
    localStorage.setItem("ciudadGuardada", ciudad);
  } catch(err) {
    console.error("Error al obtener el clima:", err);
  }
}

async function obtenerClimaPorCoordenadas(lat, lon) {
  try {
    const idioma = localStorage.getItem("idiomaSeleccionado") || "es";
    const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=${idioma}`;
    const resp = await fetch(url);
    const data = await resp.json();
    if (data.cod !== 200) {
      cityName.textContent = traducir("Ciudad no encontrada", idioma);
      details.textContent = "";
      document.getElementById("weather-temp").textContent = "";
      document.getElementById("weather-emoji").textContent = "";
      return;
    }
    document.getElementById("weather-temp").textContent = `${Math.round(data.main.temp)}°`;
    cityName.textContent = `${data.name}, ${data.sys.country}`;
    details.textContent = `${data.weather[0].description} • ${traducir("Viento", idioma)}: ${data.wind.speed} m/s • ${traducir("Min", idioma)}: ${Math.round(data.main.temp_min)}° / ${traducir("Max", idioma)}: ${Math.round(data.main.temp_max)}°`;
    document.getElementById("weather-emoji").textContent = getEmoji(data.weather[0].main);

  } catch(err) {
    console.error("Error al obtener el clima por coordenadas:", err);
  }
}
    
async function buscarCiudad(query) {
  if (!query) return [];
  try {
    const url = `https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(query)}&limit=5&appid=${apiKey}`;
    const resp = await fetch(url);
    const data = await resp.json();
    return data;
  } catch(err) {
    console.error("Error al buscar ciudad:", err);
    return [];
  }
}

function traducir(texto, idioma) {
  const diccionario = {
    "Ciudad no encontrada": { es:"Ciudad no encontrada", ca:"Ciutat no trobada", gl:"Cidade non atopada", eu:"Hiria ez da aurkitu" },
    "Viento": { es:"Viento", ca:"Vent", gl:"Vento", eu:"Haizea" },
    "Min": { es:"Min", ca:"Mín", gl:"Mín", eu:"Gutx" },
    "Max": { es:"Max", ca:"Màx", gl:"Máx", eu:"Geh" }
  };
  return diccionario[texto]?.[idioma] || texto;
}

// --- Autocompletar ciudad accesible ---
let timeoutId;
let selectedIndex = -1;
let currentSuggestions = [];

inputCity.addEventListener("input", () => {
  clearTimeout(timeoutId);
  timeoutId = setTimeout(async () => {
    const query = inputCity.value.trim();
    const lista = document.getElementById("suggestions");
    lista.innerHTML = "";
    selectedIndex = -1;
    currentSuggestions = [];
    inputCity.setAttribute("aria-expanded", "false");
    if (!query) return;
    const resultados = await buscarCiudad(query);
    currentSuggestions = resultados;
    if (resultados.length > 0) {
      resultados.forEach((ciudad, idx) => {
        const li = document.createElement("li");
        li.textContent = `${ciudad.name}, ${ciudad.country}`;
        li.setAttribute("role", "option");
        li.setAttribute("id", "suggestion-" + idx);
        li.setAttribute("tabindex", "-1");
        li.addEventListener("mousedown", e => {
          e.preventDefault();
          seleccionarCiudadSugerencia(idx);
        });
        lista.appendChild(li);
      });
      inputCity.setAttribute("aria-expanded", "true");
    }
  }, 300);
});

inputCity.addEventListener("keydown", (e) => {
  const lista = document.getElementById("suggestions");
  if (!currentSuggestions.length) return;
  if (e.key === "ArrowDown") {
    e.preventDefault();
    selectedIndex = (selectedIndex + 1) % currentSuggestions.length;
    actualizarSeleccion();
  } else if (e.key === "ArrowUp") {
    e.preventDefault();
    selectedIndex = (selectedIndex - 1 + currentSuggestions.length) % currentSuggestions.length;
    actualizarSeleccion();
  } else if (e.key === "Enter") {
    if (selectedIndex >= 0 && currentSuggestions[selectedIndex]) {
      e.preventDefault();
      seleccionarCiudadSugerencia(selectedIndex);
    }
  } else if (e.key === "Escape") {
    lista.innerHTML = "";
    selectedIndex = -1;
    currentSuggestions = [];
    inputCity.setAttribute("aria-expanded", "false");
  }
});

function actualizarSeleccion() {
  const lista = document.getElementById("suggestions");
  Array.from(lista.children).forEach((li, idx) => {
    if (idx === selectedIndex) {
      li.classList.add("active");
      li.setAttribute("aria-selected", "true");
      li.scrollIntoView({ block: "nearest" });
    } else {
      li.classList.remove("active");
      li.setAttribute("aria-selected", "false");
    }
  });
}

function seleccionarCiudadSugerencia(idx) {
  if (!currentSuggestions[idx]) return;
  inputCity.value = currentSuggestions[idx].name;
  obtenerClima(currentSuggestions[idx].name);
  inputCity.value = ""; // limpiar tras seleccionar
  document.getElementById("suggestions").innerHTML = "";
  selectedIndex = -1;
  currentSuggestions = [];
  inputCity.setAttribute("aria-expanded", "false");
  inputCity.focus();
}

document.addEventListener("mousedown", (e) => {
  const searchDiv = document.querySelector('.city-search');
  if (!searchDiv.contains(e.target)) {
    document.getElementById("suggestions").innerHTML = "";
    selectedIndex = -1;
    currentSuggestions = [];
    inputCity.setAttribute("aria-expanded", "false");
  }
});

document.querySelectorAll('#idiomas img').forEach(img => {
  img.addEventListener("keydown", function(e) {
    const idiomas = Array.from(document.querySelectorAll('#idiomas img'));
    let idx = idiomas.indexOf(document.activeElement);
    if (e.key === "ArrowRight") {
      e.preventDefault();
      idiomas[(idx + 1) % idiomas.length].focus();
    } else if (e.key === "ArrowLeft") {
      e.preventDefault();
      idiomas[(idx - 1 + idiomas.length) % idiomas.length].focus();
    } else if (e.key === " " || e.key === "Enter") {
      e.preventDefault();
      img.click();
    }
  });
});

// --- ELIMINADO: evento de buscar con botón, ya no existe el botón "Buscar" ---

function actualizarPlaceholderCiudad() {
  const lang = document.querySelector('#idiomas img.active')?.dataset.lang || 'es';
  const t = traducciones[lang];
  inputCity.placeholder = t.placeholderCiudad || "Introduce una ciudad...";
}

window.addEventListener("load", () => {
  actualizarPlaceholderCiudad();
  const ciudadGuardada = localStorage.getItem("ciudadGuardada") || "Madrid";
  obtenerClima(ciudadGuardada);
});

function actualizarIdiomaCiudad(idioma) {
  localStorage.setItem("idiomaSeleccionado", idioma);
  actualizarPlaceholderCiudad();
  const ciudadGuardada = localStorage.getItem("ciudadGuardada") || "Madrid";
  obtenerClima(ciudadGuardada);
}

// --- Limpiar resultados al enfocar inputs ---
document.getElementById("fecha").addEventListener("focus", () => {
  document.getElementById("resultado").textContent = "";
  document.getElementById("errorSemana").textContent = "";
});
document.getElementById("fechaInicio").addEventListener("focus", () => {
  document.getElementById("resultadoDias").textContent = "";
  document.getElementById("errorDias").textContent = "";
});
document.getElementById("fechaFin").addEventListener("focus", () => {
  document.getElementById("resultadoDias").textContent = "";
  document.getElementById("errorDias").textContent = "";
});
document.getElementById("semanaInput").addEventListener("focus", () => {
  document.getElementById("resultadoSemana").textContent = "";
  document.getElementById("errorRangoSemana").textContent = "";
});
document.getElementById("city-input").addEventListener("focus", () => {
  document.getElementById("suggestions").innerHTML = "";
});
</script>
</body>
</html>
