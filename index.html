<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tiempo360</title>
<link rel="icon" type="image/png" href="favicon.png">
<style>
#titulo-img { width: clamp(400px, 70vw, 900px); height: auto; max-width: 100%; display: block; margin: 0 auto; }
body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; margin: 0; transition: background-color 0.3s, color 0.3s, background-image 0.5s ease-in-out; }
body.modo-claro { background-image: url('./LIGHT.webp'); background-size: cover; background-position: center; background-repeat: no-repeat; color: #1a1a1a; }
body.modo-oscuro { background-image: url('./DARK.webp'); background-size: cover; background-position: center; background-repeat: no-repeat; color: #e0e0e0; }
.texto-azul { color: inherit; }
body.modo-claro .texto-azul { color: #4A565D !important; }
body.modo-oscuro .texto-azul { color: #5C6B73 !important; }

h1, h3 { font-size: 1.2em; margin: 10px 0; }
.reloj { font-size: 1.8em; font-weight: bold; margin: 10px 0; }
.zona, #semanaActual { font-size: 1em; font-weight: normal; margin: 10px 0; color: inherit; }

.seccion { margin: 20px auto; padding: 15px; border-radius: 8px; max-width: 600px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); background-color: rgba(255,255,255,0.9);}
body.modo-oscuro .seccion { background-color: rgba(50,50,50,0.9); box-shadow: 0 2px 6px rgba(0,0,0,0.3); }

input, button { padding: 10px; margin: 5px; font-size: 1em; border-radius: 5px; border: 1px solid #ccc; width: 90%; max-width: 300px; box-sizing: border-box;}
button { background-color: #5C6B73; color: white; border: none; cursor: pointer; transition: background-color 0.2s; }
button:hover { background-color: #4A565D; }

#modo-switch-container { display: flex; align-items: center; justify-content: center; margin: 30px 0 10px 0; }
.switch-container { display: flex; align-items: center; gap: 7px; cursor: pointer; }
#modo-switch { appearance: none; -webkit-appearance: none; width: 50px; height: 24px; background: #ccc; border-radius: 12px; position: relative; cursor: pointer; transition: background 0.2s; }
#modo-switch:checked { background: #5C6B73; }
#modo-switch::before { content: ""; position: absolute; top: 50%; left: 2px; width: 20px; height: 20px; border-radius: 50%; background: #fff; transform: translateY(-50%); transition: left 0.2s; }
#modo-switch:checked::before { left: calc(100% - 22px); }
#modo-switch:focus { outline: none; }
#modo-texto { font-weight: normal; user-select: none; }

#logo-container { width: clamp(400px, 70vw, 900px); max-width: 100%; }
#logo-color { width: 100%; height: auto; display: block; fill: currentColor; }
body.modo-claro #logo-color { color: #4A565D; }
body.modo-oscuro #logo-color { color: #5C6B73; }
#logo-overlay { width: 100%; height: auto; position: absolute; top: 0; left: 0; pointer-events: none; }


.calendar-container { max-width: 600px; margin: 20px auto; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); background-color: rgba(255,255,255,0.9); }
body.modo-oscuro .calendar-container { background-color: rgba(50,50,50,0.9);}
.calendar-container iframe { width: 100%; min-width: 250px; height: 350px; max-width: 600px; border: none; display: block; margin: 0 auto; }

.firma { margin-top: 50px; font-size: 0.8em; text-align: center; opacity: 0.7; }
body.modo-claro .firma { color: #666; }
body.modo-oscuro .firma { color: #aaa; }

.error { color: orange; font-weight: bold; font-style: italic; font-size: 0.9em; margin-top: 5px; opacity: 0; transition: opacity 0.4s; display: flex; align-items: center; justify-content: center; }
.error.visible { opacity: 1; }
.icono { margin-right: 5px; }
.input-error { border: 2px solid orange; animation: parpadeo 0.6s ease-in-out 2; }
@keyframes parpadeo { 0%,100%{ border-color: transparent;} 50%{ border-color: orange; } }

#idiomas { display: flex; justify-content: center; gap: 10px; margin-top: 30px; margin-bottom: 20px; }
#idiomas img { width: 36px; height: auto; cursor: pointer; border-radius: 4px; transition: transform 0.2s; }
#idiomas img:hover, #idiomas img.active { transform: scale(1.05); border: 2px solid #5C6B73; }

/* --- Responsive para m√≥viles --- */
@media(max-width:480px) { 
  .reloj { font-size: 1.5em;} 
  input, button { width: 95%; } 
  .calendar-container { max-width: 95vw; }
  .calendar-container iframe { height: 280px; min-width: 0; max-width: 100%; }
  #weather-widget { flex-direction: column; align-items: center; gap: 10px; }
  #weather-widget .weather-main { flex-direction: row !important; align-items: center; gap: 5px; }
}

  @media(min-width:481px) and (max-width:768px) { 
  input, button { max-width: 90%; } 
  .calendar-container { max-width: 99vw; }
  .calendar-container iframe { height: 320px; min-width: 0; max-width: 100%; }
  #weather-widget .weather-main { flex-direction: row !important; align-items: center; gap: 15px; }
}

.weather-widget-seccion { display: flex; flex-direction: column; align-items: center; gap: 15px; margin: 20px auto; }
.weather-main { display: flex; align-items: center; gap: 15px; flex-direction: row; }
.weather-info { display: flex; flex-direction: column; align-items: flex-start; }
.city-search { display: flex; flex-direction: row; justify-content: center; align-items: center; gap: 10px; position: relative; width: 100%; max-width: 400px; }
.city-search input { flex: 1; min-width: 150px; margin-right: 0; }
.suggestions-list { position: absolute; top: 100%; left: 0; right: 0; min-width: 100%; max-height: 150px; overflow-y: auto; background: #fff !important; color: #111 !important; border: 1px solid #ccc; border-radius: 4px; z-index: 10; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-top: 2px; padding: 0; list-style: none; }
.suggestions-list li { padding: 8px 12px; cursor: pointer; color: #111 !important; background: #fff !important; transition: background-color 0.2s, color 0.2s; }
.suggestions-list li.active,
.suggestions-list li:hover { background-color: #5C6B73 !important; color: #fff !important; }

#weather-temp { font-size: 1.8em; font-weight: bold; color: inherit; margin-right: 10px; display: inline-block; width: 60px; text-align: right; }
#weather-emoji { display: inline-block; width: 30px; height: 30px; line-height: 30px; font-size: 30px; text-align: center; }
#city-name { font-weight: bold; }
  
.fechas-linea { display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 8px; }
.fechas-linea label { display: flex; align-items: center; gap: 4px; }
.fechas-linea .a-label { font-weight: bold; }
.fechas-linea button { flex-shrink: 0; }

@media(max-width:480px) {
.fechas-linea { flex-direction: column; gap: 5px; }
.fechas-linea button { width: 90%; }
}


</style>
</head>
<body aria-label="Tiempo360" role="main">

  <header>
  <h1 id="titulo" tabindex="0">
    <div id="logo-container" style="position: relative; display: inline-block;">
      <!-- SVG negro que se puede colorear con CSS -->
      <img id="logo-color" src="Logoweb_Color.svg" alt="" style="display:block; width: clamp(400px, 70vw, 900px); height:auto; max-width: 100%;">
      
      <!-- Imagen con agujas rojas, tick verde y subt√≠tulo -->
      <img id="logo-overlay" src="Logoweb_Clear.png" alt="Tiempo360 - El tiempo desde todas sus dimensiones..." 
           style="position:absolute; top:0; left:0; width:100%; height:100%;">
    </div>
  </h1>
</header>

<div id="idiomas" aria-label="Selector de idioma" role="radiogroup">
  <img src="ESP.png" alt="Espa√±ol" data-lang="es" onclick="cambiarIdioma('es')" title="Espa√±ol" role="radio" aria-checked="false" tabindex="0">
  <img src="CAT.png" alt="Catal√†" data-lang="ca" onclick="cambiarIdioma('ca')" title="Catal√†" role="radio" aria-checked="false" tabindex="0">
  <img src="GAL.png" alt="Galego" data-lang="gl" onclick="cambiarIdioma('gl')" title="Galego" role="radio" aria-checked="false" tabindex="0">
  <img src="EUS.png" alt="Euskera" data-lang="eu" onclick="cambiarIdioma('eu')" title="Euskera" role="radio" aria-checked="false" tabindex="0">
</div>

<div id="modo-switch-container">
  <label class="switch-container">
    <span id="modo-texto">Modo claro/oscuro</span>
    <input type="checkbox" id="modo-switch">
  </label>
</div>

<div class="reloj texto-azul" id="reloj" aria-live="polite" aria-atomic="true"></div>
<div class="zona" id="zonaHoraria" aria-live="polite"></div>
<p id="semanaActual" aria-live="polite"></p>

<div id="weather-widget" class="weather-widget-seccion" aria-label="Widget del tiempo" role="region">
  <div class="weather-main" aria-label="Informaci√≥n meteorol√≥gica principal" role="group">
    <span id="weather-temp" class="texto-azul" aria-label="Temperatura actual"></span>
    <span id="weather-emoji" aria-label="Icono meteorol√≥gico"></span>
    <div class="weather-info" aria-label="Informaci√≥n de ciudad y detalles">
      <span id="city-name" class="texto-azul" aria-label="Ciudad"></span>
      <small id="details" aria-label="Detalles del tiempo"></small>
    </div>
  </div>

  <div class="city-search" aria-label="Buscador de ciudad" role="search">
    <input type="text" id="city-input" placeholder="Introduce una ciudad..." autocomplete="off"
     aria-autocomplete="list" aria-haspopup="listbox" aria-expanded="false" aria-controls="suggestions" aria-label="Campo de b√∫squeda de ciudad" />
    <ul id="suggestions" class="suggestions-list" role="listbox" aria-label="Sugerencias de ciudad"></ul>
  </div>
</div>

<div class="calendar-container" aria-label="Calendario de festivos" role="region">
  <iframe src="https://calendar.google.com/calendar/embed?height=600&wkst=2&ctz=Europe%2FMadrid&showPrint=0&showTitle=0&showCalendars=0&showTz=0&src=cmc2YXRmZXEyMHNkMHJxbWVpOTU3aDB0dnBlNGd2bTNAaW1wb3J0LmNhbGVuZGFyLmdvb2dsZS5jb20&src=NjI3NDg2ZDMwOWJnZ2xpbGhuOGJnN3JnbjNnaXB2M2lAaW1wb3J0LmNhbGVuZGFyLmdvb2dsZS5jb20&src=OTlvbjFkNjMyajdqNm42NDdrczQwa3UwNW5lZzZlcGNAaW1wb3J0LmNhbGVuZGFyLmdvb2dsZS5jb20&src=b3A0Y2RtNnVmaGUybmZmYTBlOThmbDJndmZ1YnRxY2VAaW1wb3J0LmNhbGVuZGFyLmdvb2dsZS5jb20&src=bHFpMWlvMXNoaGh1amFrZ2psZnQ2OWVocGtxb2MzdTdAaW1wb3J0LmNhbGVuZGFyLmdvb2dsZS5jb20&src=ZzN1M25oZ3E1cnU1amVhZGJrYzZsN3E0amgzcDY5cjRAaW1wb3J0LmNhbGVuZGFyLmdvb2dsZS5jb20&src=bWUxdXByNGludjRuanJtNjc4Zm9ldjJsdjJhMzc5MDNAaW1wb3J0LmNhbGVuZGFyLmdvb2dsZS5jb20&src=MTc4cHFpMmhwOTJiaHZjbTlvdWoyMDVvbmU3cmc5NTRAaW1wb3J0LmNhbGVuZGFyLmdvb2dsZS5jb20&src=aW80NWRsb2FsbmcxcWxpdGV2MmhuMjFzb2JuaDVlcmFAaW1wb3J0LmNhbGVuZGFyLmdvb2dsZS5jb20&src=ZnJrN21rOTluYnRicXQ3ZmNsbmJqN3Uzazdlbml0MGRAaW1wb3J0LmNhbGVuZGFyLmdvb2dsZS5jb20&src=OW0yNGZ0aW81dmw0bGk1aXRmbTIydjVpdmRzdnVxaHZAaW1wb3J0LmNhbGVuZGFyLmdvb2dsZS5jb20&src=ZXMuc3BhaW4jaG9saWRheUBncm91cC52LmNhbGVuZGFyLmdvb2dsZS5jb20&src=aTJvMTRnaDhqNmY2N29yODY1amhrcTBxbnNlMXVrdWNAaW1wb3J0LmNhbGVuZGFyLmdvb2dsZS5jb20&src=MWpqdmRlNmJibmRmaXJ2dnM4NnUzMjBzcXJkaDc1M2dAaW1wb3J0LmNhbGVuZGFyLmdvb2dsZS5jb20&src=MTIwNm9iMGhrczNkNDU5aDFxdDZtcWZkNjF1N3A4b29AaW1wb3J0LmNhbGVuZGFyLmdvb2dsZS5jb20&src=ZG5qMWh1aW5xdWpqZ2Nlajk2cjNpZzlqdTg2Y3MwZ2tAaW1wb3J0LmNhbGVuZGFyLmdvb2dsZS5jb20&src=bXNidTd1MmNhcnNnMWU1cG0xOWI4b2p0MjF1aXE0c2lAaW1wb3J0LmNhbGVuZGFyLmdvb2dsZS5jb20&src=MGduYWRqb3NibTd2am5sbTlkaDhhNDU5MHBrYWVnNTlAaW1wb3J0LmNhbGVuZGFyLmdvb2dsZS5jb20&src=OHMzMWhtZHFjbnRvMDIwc3FiZWE3bmZ2cjdwcG90Nm5AaW1wb3J0LmNhbGVuZGFyLmdvb2dsZS5jb20&src=M2w5YXNwc3AzbDZ0bjhmZTIzMGtzcTI2dmoydHNsbWtAaW1wb3J0LmNhbGVuZGFyLmdvb2dsZS5jb20&color=%230b8043&color=%230b8043&color=%230b8043&color=%230b8043&color=%230b8043&color=%230b8043&color=%230b8043&color=%230b8043&color=%230b8043&color=%230b8043&color=%230b8043&color=%23d50000&color=%230b8043&color=%230b8043&color=%230b8043&color=%230b8043&color=%230b8043&color=%230b8043&color=%230b8043&color=%230b8043" style="border-width:0" width="800" height="600" frameborder="0" scrolling="no"></iframe>
</div>  
  
<div class="seccion" aria-label="C√°lculo de n√∫mero de semana" role="region">
  <h3 class="texto-azul" id="h3Semana" tabindex="0"></h3>
  <input type="date" id="fecha" aria-label="Fecha para calcular semana">
  <button id="btnCalcularSemana" onclick="calcularSemana()" aria-label="Calcular semana"></button>
  <div class="resultado" id="resultado" aria-live="polite"></div>
  <p class="error" id="errorSemana" aria-live="assertive"><span class="icono">‚ö†Ô∏è</span></p>
</div>

<div class="seccion" aria-label="C√°lculo de d√≠as entre dos fechas" role="region">
  <h3 class="texto-azul" id="h3Dias" tabindex="0"></h3>
  <div class="fechas-linea">
    <label>
      <span class="label-de">De:</span>
      <input type="date" id="fechaInicio" aria-label="Fecha de inicio">
    </label>
    <label>
      <span class="label-a">a:</span>
      <input type="date" id="fechaFin" aria-label="Fecha de fin">
    </label>
  </div>
  <button id="btnCalcularDias" aria-label="Calcular d√≠as"></button>
  <p class="resultado" id="resultadoDias" aria-live="polite"></p>
  <p class="error" id="errorDias" aria-live="assertive"><span class="icono">‚ö†Ô∏è</span></p>
</div>

<div class="seccion" aria-label="C√°lculo de fechas de una semana" role="region">
  <h3 class="texto-azul" id="h3Rango" tabindex="0"></h3>
  <label id="labelSemana" for="semanaInput"></label>
  <input type="number" id="semanaInput" min="1" max="53" aria-label="N√∫mero de semana">
  <button id="btnMostrarRango" onclick="calcularRangoSemana()" aria-label="Mostrar rango de semana"></button>
  <p class="resultado" id="resultadoSemana" aria-live="polite"></p>
  <p class="error" id="errorRangoSemana" aria-live="assertive"><span class="icono">‚ö†Ô∏è</span></p>
</div>

<footer class="firma" id="footerFirma" tabindex="0" aria-label="Pie de p√°gina"></footer>

<script>
// --- Traducciones coherentes ---
const traducciones = {
  es: {
    tituloAlt: "Tiempo360 - El tiempo desde todas sus dimensiones...",
    lugarLabel: "Lugar:",
    buscarBtn: "Buscar",
    h3Semana: "N√∫mero de semana",
    btnCalcularSemana: "Calcular",
    semanaDe: "{fecha} > Semana {semana}",
    diasEntre: "{total} d√≠as ({a√±os} a√±os, {meses} meses, {dias} d√≠as)",
    rangoSemana: "Semana {semana}: del {inicio} al {fin}",
    h3Dias: "Tiempo entre dos fechas",
    labelDe: "De:",
    labelA: "a:",
    btnCalcularDias: "Calcular",
    h3Rango: "Fechas de una semana",
    labelSemana: "Semana del a√±o (1-53):",
    btnMostrarRango: "Mostrar",
    placeholderInicio: "Fecha de inicio",
    placeholderFin: "Fecha de fin",
    placeholderSemana: "N√∫mero de semana",
    placeholderCiudad: "Introduce una ciudad...",
    errorFecha: "Introduce una fecha v√°lida.",
    errorFechas: "Introduce fechas v√°lidas en ambos campos.",
    errorFinAntesInicio: "La fecha final no puede ser anterior a la inicial.",
    errorSemana: "Introduce un n√∫mero de semana v√°lido entre 1 y 53.",
    horaActual: "Hora actual:",
    zonaHorariaTpl: "Hora local de Espa√±a ({gmt})",
    semanaActual: "Hoy es {fecha} y estamos en la semana n√∫mero {semana} del a√±o.",
    footer: "El sitio podr√≠a contener errores, por favor contrasta la informaci√≥n.<br><br><strong>Tiempo360.</strong> <em>El tiempo, desde todas sus dimensiones...</em><br>2025 - Todos los derechos reservados"
},
  ca: {
    tituloAlt: "Tiempo360 - El temps des de totes les seves dimensions...",
    lugarLabel: "Lloc:",
    buscarBtn: "Cercar",
    h3Semana: "N√∫mero de setmana",
    btnCalcularSemana: "Calcular",
    semanaDe: "{fecha} > Setmana {semana}",
    diasEntre: "{total} dies ({a√±os} anys, {meses} mesos, {dias} dies)",
    rangoSemana: "Setmana {semana}: del {inicio} al {fin}",
    h3Dias: "Temps entre dues dates",
    labelDe: "De:",
    labelA: "a:",
    btnCalcularDias: "Calcular",
    h3Rango: "Dates d‚Äôuna setmana",
    labelSemana: "Setmana de l‚Äôany (1-53):",
    btnMostrarRango: "Mostrar",
    placeholderInicio: "Data d'inici",
    placeholderFin: "Data de fi",
    placeholderSemana: "N√∫mero de setmana",
    placeholderCiudad: "Introdueix una ciutat...",
    errorFecha: "Introdueix una data v√†lida.",
    errorFechas: "Introdueix dates v√†lides en tots dos camps.",
    errorFinAntesInicio: "La data final no pot ser anterior a la inicial.",
    errorSemana: "Introdueix un n√∫mero de setmana v√†lid entre 1 i 53.",
    horaActual: "Hora actual:",
    zonaHorariaTpl: "Hora local d'Espanya ({gmt})",
    semanaActual: "Avui √©s {fecha} i estem a la setmana n√∫mero {semana} de l‚Äôany.",
    footer: "El lloc podria contenir errors, si us plau contrasta la informaci√≥.<br><br><strong>Tiempo360.</strong> <em>El temps, des de totes les seves dimensions...</em><br>2025 - Tots els drets reservats"
},
  gl: {
    tituloAlt: "Tiempo360 - O tempo desde todas as s√∫as dimensi√≥ns...",
    lugarLabel: "Lugar:",
    buscarBtn: "Buscar",
    h3Semana: "N√∫mero de semana",
    btnCalcularSemana: "Calcular",
    semanaDe: "{fecha} > Semana {semana}",
    diasEntre: "{total} d√≠as ({a√±os} anos, {meses} meses, {dias} d√≠as)",
    rangoSemana: "Semana {semana}: do {inicio} ao {fin}",
    h3Dias: "Tempo entre d√∫as datas",
    labelDe: "De:",
    labelA: "a:",
    btnCalcularDias: "Calcular",
    h3Rango: "Datas dunha semana",
    labelSemana: "Semana do ano (1-53):",
    btnMostrarRango: "Mostrar",
    placeholderInicio: "Data de inicio",
    placeholderFin: "Data de fin",
    placeholderSemana: "N√∫mero de semana",
    placeholderCiudad: "Introduce unha cidade...",
    errorFecha: "Introduce unha data v√°lida.",
    errorFechas: "Introduce datas v√°lidas en ambos campos.",
    errorFinAntesInicio: "A data final non pode ser anterior √° inicial.",
    errorSemana: "Introduce un n√∫mero de semana v√°lido entre 1 e 53.",
    horaActual: "Hora actual:",
    zonaHorariaTpl: "Hora local de Espa√±a ({gmt})",
    semanaActual: "Hoxe √© {fecha} e estamos na semana n√∫mero {semana} do ano.",
    footer: "O sitio pode conter erros, por favor contrasta a informaci√≥n.<br><br><strong>Tiempo360.</strong> <em>O tempo desde todas as s√∫as dimensi√≥ns...</em><br>2025 - Todos os dereitos reservados"
},
  eu: {
    tituloAlt: "Tiempo360 - Denbora bere dimentsio guztietatik...",
    lugarLabel: "Lekua:",
    buscarBtn: "Bilatu",
    h3Semana: "Aste zenbakia",
    btnCalcularSemana: "Kalkulatu",
    semanaDe: "{fecha} > {semana}. astea",
    diasEntre: "{total} egun ({a√±os} urte, {meses} hilabete, {dias} egun)",
    rangoSemana: "{semana}. astea: {inicio}tik {fin}ra",
    h3Dias: "Bi daten arteko denbora",
    labelDe: "Hasiera:",
    labelA: "eta",
    btnCalcularDias: "Kalkulatu",
    h3Rango: "Aste bateko datak",
    labelSemana: "Urteko astea (1-53):",
    btnMostrarRango: "Erakutsi",
    placeholderInicio: "Hasiera data",
    placeholderFin: "Amaiera data",
    placeholderSemana: "Aste zenbakia",
    placeholderCiudad: "Hiri bat sartu...",
    errorFecha: "Sartu baliozko data bat.",
    errorFechas: "Sartu baliozko datak bi eremuetan.",
    errorFinAntesInicio: "Amaiera data ezin da hasierakoa baino lehenagokoa izan.",
    errorSemana: "Sartu 1 eta 53 arteko aste-zenbaki baliozkoa.",
    horaActual: "Ordu orain:",
    zonaHorariaTpl: "Espainiako ordu lokala ({gmt})",
    semanaActual: "Gaur {fecha} da eta urteko {semana}. astean gaude.",
    footer: "Guneak akatsak izan ditzake, mesedez kontrastatu informazioa.<br><br><strong>Tiempo360.</strong> <em>Denbora, bere dimentsio guztietatik...</em><br>2025 - Eskubide guztiak erreserbatuta"
}
};

// --- Texto switch modo ---
const textoSwitch = { es: "Modo claro/oscuro", ca: "Mode clar/fosc", gl: "Modo claro/escuro", eu: "Argi/ilun modua" };

// --- Elementos principales ---
const modoSwitch = document.getElementById('modo-switch');
const modoTexto = document.getElementById('modo-texto');
const inputCity = document.getElementById("city-input");
const cityName = document.getElementById("city-name");
const details = document.getElementById("details");

// --- Funciones auxiliares ---
const formatoFecha = fecha => {
  const dia = String(fecha.getDate()).padStart(2,'0');
  const mes = String(fecha.getMonth()+1).padStart(2,'0');
  const a√±o = fecha.getFullYear();
  return `${dia}/${mes}/${a√±o}`;
};
const obtenerGMTMadrid = () => - (new Date().getTimezoneOffset()) === 120 ? 'GMT+2' : 'GMT+1';

// --- Manejo de errores ---
function mostrarError(inputId,errorId,mensaje){
  const input = document.getElementById(inputId);
  const error = document.getElementById(errorId);
  if(input) input.classList.add('input-error');
  if(error){ error.innerHTML = `<span class="icono">‚ö†Ô∏è</span>${mensaje}`; error.classList.add('visible'); }
  setTimeout(()=>{ if(input) input.classList.remove('input-error'); },1200);
  setTimeout(()=>{ if(error) error.classList.remove('visible'); },3000);
}

// --- Modo claro/oscuro ---
function toggleModo(){
  document.body.classList.toggle('modo-oscuro');
  document.body.classList.toggle('modo-claro');
  localStorage.setItem('modo', document.body.classList.contains('modo-oscuro') ? 'oscuro' : 'claro');
  actualizarLogo();
}

// --- Actualiza logo y alt ---
function actualizarLogo(){
  const overlay = document.getElementById('logo-overlay');
  if(!overlay) return;
  const lang = document.querySelector('#idiomas img.active')?.dataset.lang || 'es';
  const t = traducciones[lang];
  overlay.src = document.body.classList.contains('modo-oscuro') ? 'Logoweb_Dark.png' : 'Logoweb_Clear.png';
  overlay.alt = t.tituloAlt || "Tiempo360 - El tiempo desde todas sus dimensiones...";
}

// --- Texto switch ---
function actualizarTextoSwitch(lang){
  modoTexto.textContent = textoSwitch[lang] || textoSwitch.es;
}

// --- Cambio de idioma ---
function cambiarIdioma(lang){
  localStorage.setItem("idiomaSeleccionado", lang);
  document.documentElement.lang = lang;
  document.querySelectorAll('#idiomas img').forEach(img => {
    img.classList.remove('active');
    img.setAttribute("aria-checked","false");
  });
  const img = document.querySelector(`#idiomas img[data-lang="${lang}"]`);
  if(img){ img.classList.add('active'); img.setAttribute("aria-checked","true"); img.focus(); }
  const t = traducciones[lang];

  // Actualiza textos principales
  actualizarTextoSwitch(lang);
  actualizarLogo();
  actualizarPlaceholderCiudad();
  mostrarSemanaActual(lang);
  actualizarReloj();
  actualizarIdiomaCiudad(lang);

  document.getElementById('h3Semana').textContent = t.h3Semana;
  document.getElementById('btnCalcularSemana').textContent = t.btnCalcularSemana;
  document.getElementById('h3Dias').textContent = t.h3Dias;
  document.querySelector(".fechas-linea .label-de").textContent = t.labelDe;
  document.querySelector(".fechas-linea .label-a").textContent = t.labelA;
  document.getElementById("btnCalcularDias").textContent = t.btnCalcularDias;
  document.getElementById('h3Rango').textContent = t.h3Rango;
  document.getElementById('labelSemana').textContent = t.labelSemana;
  document.getElementById('btnMostrarRango').textContent = t.btnMostrarRango;
  document.getElementById('footerFirma').innerHTML = t.footer;
}

// --- Reloj ---
function actualizarReloj(){
  const ahora = new Date();
  const lang = document.querySelector('#idiomas img.active')?.dataset.lang || 'es';
  const t = traducciones[lang];
  document.getElementById("reloj").innerText = `${t.horaActual} ${ahora.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false,timeZone:'Europe/Madrid'})}`;
  document.getElementById("zonaHoraria").innerText = t.zonaHorariaTpl.replace("{gmt}", obtenerGMTMadrid());
}

// --- Semana actual ---
function getSemanaISO(fecha){
  const tmp = new Date(fecha.getTime());
  tmp.setHours(0,0,0,0);
  tmp.setDate(tmp.getDate() + 3 - (tmp.getDay() + 6) % 7);
  const primerJueves = new Date(tmp.getFullYear(),0,4);
  return 1 + Math.round((tmp - primerJueves)/(7*24*60*60*1000));
}
function mostrarSemanaActual(lang){
  const hoy = new Date();
  const semanaActual = getSemanaISO(hoy);
  const t = traducciones[lang];
  document.getElementById("semanaActual").innerText = t.semanaActual
    .replace("{fecha}", formatoFecha(hoy))
    .replace("{semana}", semanaActual);
}

// --- Placeholder ciudad ---
function actualizarPlaceholderCiudad(){
  const lang = document.querySelector('#idiomas img.active')?.dataset.lang || 'es';
  inputCity.placeholder = traducciones[lang].placeholderCiudad || "Introduce una ciudad...";
}

// --- Clima ---
const apiKey = "6190233d77058dc3f79f839252cc0058";

function getEmoji(weatherMain){
  const mapping = {Thunderstorm:"‚õàÔ∏è",Drizzle:"üå¶Ô∏è",Rain:"üåßÔ∏è",Snow:"‚ùÑÔ∏è",Clear:"‚òÄÔ∏è",Clouds:"‚òÅÔ∏è",Mist:"üå´Ô∏è",Smoke:"üí®",Haze:"üå§Ô∏è",Dust:"üå™Ô∏è",Fog:"üå´Ô∏è",Sand:"üèúÔ∏è",Ash:"üåã",Squall:"üí®",Tornado:"üå™Ô∏è"};
  return mapping[weatherMain]||"üåç";
}
async function buscarCiudad(query){
  if(!query) return [];
  try {
    const resp = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(query)}&limit=5&appid=${apiKey}`);
    return await resp.json();
  } catch(e){ console.error(e); return []; }
}
async function obtenerClima(ciudad){
  try {
    const lang = localStorage.getItem("idiomaSeleccionado") || "es";
    const resultados = await buscarCiudad(ciudad);
    if(!resultados[0]){
      cityName.textContent = traducir("Ciudad no encontrada", lang);
      details.textContent = "";
      document.getElementById("weather-temp").textContent = "";
      document.getElementById("weather-emoji").textContent = "";
      return;
    }
    const {lat, lon} = resultados[0];
    await obtenerClimaPorCoordenadas(lat, lon);
    localStorage.setItem("ciudadGuardada", ciudad);
  } catch(e){ console.error(e); }
}
async function obtenerClimaPorCoordenadas(lat, lon){
  try {
    const lang = localStorage.getItem("idiomaSeleccionado") || "es";
    const resp = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=${lang}`);
    const data = await resp.json();
    if(data.cod!==200){
      cityName.textContent = traducir("Ciudad no encontrada", lang);
      details.textContent = "";
      document.getElementById("weather-temp").textContent = "";
      document.getElementById("weather-emoji").textContent = "";
      return;
    }
    document.getElementById("weather-temp").textContent = `${Math.round(data.main.temp)}¬∞`;
    cityName.textContent = `${data.name}, ${data.sys.country}`;
    details.textContent = `${data.weather[0].description} ‚Ä¢ ${traducir("Viento",lang)}: ${data.wind.speed} m/s ‚Ä¢ ${traducir("Min",lang)}: ${Math.round(data.main.temp_min)}¬∞ / ${traducir("Max",lang)}: ${Math.round(data.main.temp_max)}¬∞`;
    document.getElementById("weather-emoji").textContent = getEmoji(data.weather[0].main);
  } catch(e){ console.error(e); }
}
function traducir(texto, idioma){
  const dic = { "Ciudad no encontrada": { es:"Ciudad no encontrada", ca:"Ciutat no trobada", gl:"Cidade non atopada", eu:"Hiria ez da aurkitu" },
                "Viento": { es:"Viento", ca:"Vent", gl:"Vento", eu:"Haizea" },
                "Min": { es:"Min", ca:"M√≠n", gl:"M√≠n", eu:"Gutx" },
                "Max": { es:"Max", ca:"M√†x", gl:"M√°x", eu:"Geh" } };
  return dic[texto]?.[idioma]||texto;
}

// --- Autocompletado ciudad ---
let timeoutId, selectedIndex = -1, currentSuggestions = [];
inputCity.addEventListener("input", ()=>{
  clearTimeout(timeoutId);
  timeoutId = setTimeout(async ()=>{
    const query = inputCity.value.trim();
    const lista = document.getElementById("suggestions");
    lista.innerHTML=""; selectedIndex=-1; currentSuggestions=[]; inputCity.setAttribute("aria-expanded","false");
    if(!query) return;
    const resultados = await buscarCiudad(query);
    currentSuggestions = resultados;
    if(resultados.length>0){
      resultados.forEach((ciudad, idx)=>{
        const li = document.createElement("li");
        li.textContent = `${ciudad.name}, ${ciudad.country}`;
        li.setAttribute("role","option");
        li.setAttribute("id","suggestion-"+idx);
        li.setAttribute("tabindex","-1");
        li.addEventListener("mousedown", e=>{ e.preventDefault(); seleccionarCiudadSugerencia(idx); });
        lista.appendChild(li);
      });
      inputCity.setAttribute("aria-expanded","true");
    }
  },300);
});
inputCity.addEventListener("keydown", (e)=>{
  const lista = document.getElementById("suggestions");
  if(!currentSuggestions.length) return;
  if(e.key==="ArrowDown"){ e.preventDefault(); selectedIndex=(selectedIndex+1)%currentSuggestions.length; actualizarSeleccion(); }
  else if(e.key==="ArrowUp"){ e.preventDefault(); selectedIndex=(selectedIndex-1+currentSuggestions.length)%currentSuggestions.length; actualizarSeleccion(); }
  else if(e.key==="Enter"){ if(selectedIndex>=0 && currentSuggestions[selectedIndex]){ e.preventDefault(); seleccionarCiudadSugerencia(selectedIndex); } }
  else if(e.key==="Escape"){ lista.innerHTML=""; selectedIndex=-1; currentSuggestions=[]; inputCity.setAttribute("aria-expanded","false"); }
});
function actualizarSeleccion(){
  const lista = document.getElementById("suggestions");
  Array.from(lista.children).forEach((li, idx)=>{
    if(idx===selectedIndex){ li.classList.add("active"); li.setAttribute("aria-selected","true"); li.scrollIntoView({block:"nearest"}); }
    else{ li.classList.remove("active"); li.setAttribute("aria-selected","false"); }
  });
}
function seleccionarCiudadSugerencia(idx){
  if(!currentSuggestions[idx]) return;
  inputCity.value=currentSuggestions[idx].name;
  obtenerClima(currentSuggestions[idx].name);
  inputCity.value=""; document.getElementById("suggestions").innerHTML="";
  selectedIndex=-1; currentSuggestions=[]; inputCity.setAttribute("aria-expanded","false"); inputCity.focus();
}
document.addEventListener("mousedown", e=>{
  const searchDiv = document.querySelector('.city-search');
  if(!searchDiv.contains(e.target)){
    document.getElementById("suggestions").innerHTML=""; selectedIndex=-1; currentSuggestions=[]; inputCity.setAttribute("aria-expanded","false");
  }
});

// --- Inicializaci√≥n ---
window.addEventListener("load", ()=>{
  // Modo
  const modoGuardado = localStorage.getItem('modo')||'claro';
  document.body.classList.add(modoGuardado==='oscuro'?'modo-oscuro':'modo-claro');
  modoSwitch.checked = modoGuardado==='oscuro';

  // Idioma
  const lang = localStorage.getItem("idiomaSeleccionado") || 'es';
  cambiarIdioma(lang);

  // Clima
  const ciudadGuardada = localStorage.getItem("ciudadGuardada") || "Madrid";
  obtenerClima(ciudadGuardada);

  actualizarReloj();
  actualizarPlaceholderCiudad();
});
modoSwitch.addEventListener('change', toggleModo);

</script>
</body>
</html>
