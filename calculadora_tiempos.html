<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculadora de Tiempos</title>
<link rel="stylesheet" href="tu_estilo.css"> <!-- tu CSS global -->

<style>
body { margin: 0; overflow-x: hidden; font-family: 'Segoe UI', sans-serif; }

.calculadora {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
  max-width: 360px;
  margin: 20px auto;
  padding: 10px;
  box-sizing: border-box;
  min-height: auto;
}

.display {
  grid-column: 1 / 5;
  font-size: 1.4em;
  padding: 10px;
  text-align: right;
  border-radius: 5px;
  border: 1px solid #ccc;
  box-sizing: border-box;
  background-color: #f0f0f0;
  min-height: 45px;
  overflow-x: auto;
}

button {
  padding: 15px;
  font-size: 1.1em;
  border-radius: 5px;
  border: none;
  cursor: pointer;
  transition: background-color 0.2s;
}

/* Color neutro números y switch (modo claro) */
button.color1 { background-color: #c0c0c0; color: #000; }

/* Color neutro números y switch (modo oscuro) */
body.modo-oscuro button.color1 { background-color: #555; color: #fff; }

/* Operaciones */
button.color2 { background-color: #5C6B73; color: #fff; }
button.color2:hover { background-color: #4A565D; }

</style>
</head>
<body>

<div class="calculadora">
  <input type="text" class="display" id="display" readonly>

  <!-- Switch formato horas/decimales -->
  <button id="switchFormato" class="color1" title="Cambiar formato h/dec">h/dec</button>

  <!-- Fila 1 -->
  <button class="color2" data-unit="h">H</button>
  <button class="color2" data-unit="m">M</button>
  <button class="color2" data-unit="s">S</button>
  <button class="color2" data-op="÷">÷</button>

  <!-- Fila 2 -->
  <button class="color1" data-num="7">7</button>
  <button class="color1" data-num="8">8</button>
  <button class="color1" data-num="9">9</button>
  <button class="color2" data-op="×">×</button>

  <!-- Fila 3 -->
  <button class="color1" data-num="4">4</button>
  <button class="color1" data-num="5">5</button>
  <button class="color1" data-num="6">6</button>
  <button class="color2" data-op="-">-</button>

  <!-- Fila 4 -->
  <button class="color1" data-num="1">1</button>
  <button class="color1" data-num="2">2</button>
  <button class="color1" data-num="3">3</button>
  <button class="color2" data-op="+">+</button>

  <!-- Fila 5 -->
  <button class="color1" data-num="0">0</button>
  <button class="color2" id="clear">C</button>
  <button class="color2" id="igual">=</button>
</div>

<script>
// Variables principales
const display = document.getElementById('display');
let expression = '';
let modeDecimal = false;

// Cambio de formato h/dec
const switchBtn = document.getElementById('switchFormato');
switchBtn.addEventListener('click', () => {
  modeDecimal = !modeDecimal;
  if(modeDecimal){
    switchBtn.classList.remove('color1');
    switchBtn.classList.add('color2');
  } else {
    switchBtn.classList.remove('color2');
    switchBtn.classList.add('color1');
  }
  actualizarDisplay();
});

// Botones numéricos
document.querySelectorAll('[data-num]').forEach(btn=>{
  btn.addEventListener('click', ()=>{ expression += btn.dataset.num; actualizarDisplay(); });
});

// Botones de unidades H/M/S
document.querySelectorAll('[data-unit]').forEach(btn=>{
  btn.addEventListener('click', ()=>{ expression += btn.dataset.unit; actualizarDisplay(); });
});

// Botones de operaciones
document.querySelectorAll('[data-op]').forEach(btn=>{
  btn.addEventListener('click', ()=>{ expression += ' ' + btn.dataset.op + ' '; actualizarDisplay(); });
});

// Botón C
document.getElementById('clear').addEventListener('click', ()=>{
  expression = '';
  actualizarDisplay();
});

// Botón =
document.getElementById('igual').addEventListener('click', ()=>{
  expression = calcular(expression);
  actualizarDisplay();
});

// Actualiza display
function actualizarDisplay(){
  display.value = expression;
}

// --- Lógica de cálculo de tiempos ---
function calcular(exp){
  try {
    let tokens = exp.split(/\s+/).filter(t=>t!=='');
    if(tokens.length === 0) return '';

    let stack = [];
    let currentOp = null;

    function tokenToHours(token){
      if(token.endsWith('h')) return parseFloat(token.replace('h','')) || 0;
      if(token.endsWith('m')) return (parseFloat(token.replace('m',''))||0)/60;
      if(token.endsWith('s')) return (parseFloat(token.replace('s',''))||0)/3600;
      if(!isNaN(parseFloat(token))) return parseFloat(token);
      return 0;
    }

    for(let token of tokens){
      if(['+', '-', '×', '÷'].includes(token)){
        currentOp = token;
      } else {
        let val = tokenToHours(token);
        if(currentOp){
          if(currentOp==='+') stack.push(stack.pop() + val);
          else if(currentOp==='-') stack.push(stack.pop() - val);
          else if(currentOp==='×') stack.push(stack.pop() * val);
          else if(currentOp==='÷') stack.push(stack.pop() / val);
          currentOp = null;
        } else {
          stack.push(val);
        }
      }
    }

    let totalH = stack.reduce((a,b)=>a+b,0);

    if(!modeDecimal){
      let h = Math.floor(totalH);
      let m = Math.floor((totalH - h)*60);
      let s = Math.round(((totalH - h)*60 - m)*60);
      return `${h}h ${m}m ${s}s`;
    } else {
      return totalH.toFixed(2);
    }

  } catch(e) {
    return 'Error';
  }
}

// Teclado físico seguro (solo ordenador)
document.addEventListener('keydown', (e)=>{
  if(e.key.match(/[0-9]/)) expression += e.key;
  else if(['h','m','s','+','-','*','/'].includes(e.key)) expression += e.key==='*'?'×': e.key==='/'?'÷': e.key;
  else if(e.key==='Enter') expression = calcular(expression);
  else if(e.key==='Backspace') expression = expression.slice(0,-1);
  actualizarDisplay();
});

// --- Ajuste automático de altura para iframe ---
function ajustarAltura() {
  const altura = document.body.scrollHeight;
  window.parent.postMessage({ tipo: 'ajustarAlturaCalculadora', altura }, '*');
}
window.addEventListener('load', ajustarAltura);
const observer = new MutationObserver(ajustarAltura);
observer.observe(document.body, { childList: true, subtree: true });

</script>

</body>
</html>
