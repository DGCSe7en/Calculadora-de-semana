<script>
const display = document.getElementById('display');
let expression = '';
let modeDecimal = true; // true = decimal, false = horas

const unitButtons = document.querySelectorAll('[data-unit]');

// Ajusta altura del iframe
function ajustarAltura() {
  const altura = document.body.scrollHeight;
  parent.postMessage({ tipo: 'ajustarAlturaCalculadora', altura }, '*');
}

// Actualiza display
function actualizarDisplay(){
  display.value = expression;
  ajustarAltura();
}

// Actualiza botones H/M/S
function actualizarBotones() {
  if(modeDecimal){
    unitButtons.forEach(btn => { btn.disabled = true; btn.style.opacity="0.5"; btn.style.cursor="not-allowed"; });
  } else {
    unitButtons.forEach(btn => { btn.disabled = false; btn.style.opacity="1"; btn.style.cursor="pointer"; });
  }
}

// Botones numéricos
document.querySelectorAll('[data-num]').forEach(btn=>{
  btn.addEventListener('click', ()=>{ expression += btn.dataset.num; actualizarDisplay(); });
});

// Botones H/M/S
unitButtons.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    if(expression && !expression.endsWith(' ')) expression += ' ';
    expression += btn.dataset.unit + ' ';
    actualizarDisplay();
  });
});

// Botones operaciones
document.querySelectorAll('[data-op]').forEach(btn=>{
  btn.addEventListener('click', ()=>{ expression += ' ' + btn.dataset.op + ' '; actualizarDisplay(); });
});

// Botón C
document.getElementById('clear').addEventListener('click', ()=>{
  expression = '';
  actualizarDisplay();
});

// Botón coma
document.getElementById('coma').addEventListener('click', ()=>{
  if(!modeDecimal) return;
  expression += '.';
  actualizarDisplay();
});

// Botón paréntesis
document.getElementById('parAbre').addEventListener('click', ()=>{ expression += '('; actualizarDisplay(); });
document.getElementById('parCierra').addEventListener('click', ()=>{ expression += ')'; actualizarDisplay(); });

// Botón %
document.getElementById('porcentaje').addEventListener('click', ()=>{
  if(modeDecimal) expression += '%'; actualizarDisplay();
});

// Borrar 1 carácter
document.getElementById('borrar1').addEventListener('click', ()=>{
  expression = expression.slice(0,-1);
  actualizarDisplay();
});

// Botón =
document.getElementById('igual').addEventListener('click', ()=>{
  expression = calcular(expression);
  actualizarDisplay();
});

// Switch invertido
const switchBtn = document.getElementById('switchFormato');
switchBtn.addEventListener('change', ()=>{
  modeDecimal = !switchBtn.checked; 
  actualizarBotones();
});

// Teclado físico
document.addEventListener('keydown', (e)=>{
  if(e.key.match(/[0-9]/)) expression += e.key;
  else if(['h','m','s','+','-','*','/','(',')'].includes(e.key)) expression += e.key==='*'?'×': e.key==='/'?'÷': e.key;
  else if(e.key==='Enter') expression = calcular(expression);
  else if(e.key==='Backspace') expression = expression.slice(0,-1);
  actualizarDisplay();
});

// --- Lógica de cálculo ---
function calcular(exp){
  try {
    if(modeDecimal){
      exp = exp.replace(/×/g,'*').replace(/÷/g,'/').replace(/%/g,'/100');
      return eval(exp).toString();
    } else {
      let tokens = exp.split(/\s+/).filter(t=>t!=='');
      if(tokens.length===0) return '';

      let stack=[], currentOp=null;

      function tokenToHours(token){
        token = token.trim();
        if(token.endsWith('h')) return parseFloat(token.replace('h',''))||0;
        if(token.endsWith('m')) return (parseFloat(token.replace('m',''))||0)/60;
        if(token.endsWith('s')) return (parseFloat(token.replace('s',''))||0)/3600;
        if(!isNaN(parseFloat(token))) return parseFloat(token);
        return 0;
      }

      for(let token of tokens){
        if(['+', '-', '×', '÷'].includes(token)){ 
          currentOp=token; 
        } else {
          let val = tokenToHours(token);
          if(currentOp){
            if(currentOp==='+') stack.push(stack.pop()+val);
            else if(currentOp==='-') stack.push(stack.pop()-val);
            else if(currentOp==='×') stack.push(stack.pop()*val);
            else if(currentOp==='÷') stack.push(stack.pop()/val);
            currentOp=null;
          } else stack.push(val);
        }
      }

      let totalH = stack.reduce((a,b)=>a+b,0);
      let h=Math.floor(totalH);
      let m=Math.floor((totalH-h)*60);
      let s=Math.round(((totalH-h)*60 - m)*60);

      return `${h}h ${m}m ${s}s`;
    }
  } catch(e){
    return 'Error';
  }
}

// Ajuste inicial
window.addEventListener('load', ()=>{
  actualizarBotones();
  actualizarDisplay();
});
</script>
